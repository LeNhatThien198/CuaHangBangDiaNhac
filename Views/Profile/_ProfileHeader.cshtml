@using Microsoft.AspNetCore.Identity
@using CuaHangBangDiaNhac.Models
@inject UserManager<User> UserManager

@{
    var user = await UserManager.GetUserAsync(User);
    var activeTab = ViewData["ActiveTab"] as string ?? "Overview";
}

<div class="artist-header-wrapper">
    <div class="artist-cover">
        <!-- Optional: Cover Image Logic if needed later -->
    </div>

    <div class="container-fluid artist-info-container">
        <div class="artist-avatar-wrapper">
             @if (string.IsNullOrEmpty(user?.AvatarUrl))
             {
                 <img id="profileAvatar" src="/images/default-avatar.png" alt="Avatar" class="artist-avatar">
             }
             else
             {
                 <img id="profileAvatar" src="@user.AvatarUrl" alt="Avatar" class="artist-avatar">
             }
             
             @if(activeTab == "Overview") 
             {
                 <span id="avatarEditBtn" class="artist-avatar-edit" title="Đổi ảnh đại diện">
                     <i class="bi bi-pencil-fill"></i>
                 </span>
             }
        </div>
        
        <div class="artist-details mb-4">
            <span class="badge rounded-pill text-uppercase text-white border-white bg-white bg-opacity-25">Hồ sơ cá nhân</span>
            <h1 class="text-white">@(user?.FullName ?? user?.UserName)</h1>
            <div class="d-flex align-items-center gap-3 mt-3 text-white-50">
                @if(User.IsInRole("Admin")) 
                { 
                    <span class="text-warning fw-bold"><i class="bi bi-shield-fill-check me-2"></i>Quản trị viên</span> 
                }
                else if(User.IsInRole("Staff")) 
                { 
                    <span class="text-warning fw-bold"><i class="bi bi-person-badge-fill me-2"></i>Nhân viên</span> 
                }
                else 
                { 
                    <span class="text-white fw-bold"><i class="bi bi-music-note-beamed me-2"></i>Thành viên yêu nhạc</span> 
                }
                
                <span class="text-white-50">•</span>
                <span class="text-white">@(user?.Email)</span>
            </div>
        </div>
    </div>

    <div class="artist-nav">
        <a asp-controller="Profile" asp-action="Index" class="artist-nav-link @(activeTab == "Overview" ? "active" : "")">Tổng quan</a>
        @if (!User.IsInRole("Admin"))
        {
            <a asp-controller="Order" asp-action="History" class="artist-nav-link @(activeTab == "History" ? "active" : "")">Lịch sử đơn hàng</a>
        }
        
        @if (!User.IsInRole("Admin") && !User.IsInRole("Staff"))
        {
           <a asp-controller="Profile" asp-action="Address" class="artist-nav-link @(activeTab == "Address" ? "active" : "")">Sổ địa chỉ</a>
        }
        
        <a asp-controller="Profile" asp-action="ChangePassword" class="artist-nav-link @(activeTab == "Security" ? "active" : "")">Bảo mật</a>
         
         <form asp-controller="Account" asp-action="Logout" method="post" class="d-inline ms-auto">
            <button type="submit" class="btn text-white fw-bold text-uppercase opacity-75 hover-opacity-100" style="background:none; border:none; letter-spacing:1px;">
                Đăng xuất <i class="bi bi-box-arrow-right ms-2"></i>
            </button>
        </form>
    </div>
</div>

<div id="avatarOverlay" class="image-viewer-overlay" style="display:none;">
    <div id="avatarCloseBtn" class="viewer-close-btn">&times;</div>
    <div class="viewer-content-wrapper">
        <img id="avatarViewerImg" class="viewer-img" src="@((string.IsNullOrEmpty(user?.AvatarUrl) ? "/images/default-avatar.png" : user.AvatarUrl))" alt="Avatar">
        <div class="mt-3 d-flex justify-content-center gap-2">
            <button type="button" class="btn btn-warning fw-bold" id="btnChangeAvatar"><i class="bi bi-upload me-2"></i>Thay đổi ảnh đại diện</button>
        </div>
        <input type="file" id="avatarUploadInput" class="d-none" accept="image/*" />
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const avatarImgs = document.querySelectorAll('.artist-avatar');
    const overlay = document.getElementById('avatarOverlay');
    const viewerImg = document.getElementById('avatarViewerImg');
    const closeBtn = document.getElementById('avatarCloseBtn');
    const changeBtn = document.getElementById('btnChangeAvatar');
    const uploadInput = document.getElementById('avatarUploadInput');
    const editBtn = document.getElementById('avatarEditBtn');
    const mainAvatar = document.getElementById('profileAvatar');

    const openOverlay = (src) => {
        viewerImg.src = src;
        overlay.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    };
    const closeOverlay = () => {
        overlay.style.display = 'none';
        document.body.style.overflow = '';
    };

    avatarImgs.forEach(img => {
        img.style.cursor = 'pointer';
        img.addEventListener('click', () => openOverlay(img.src));
    });

    editBtn?.addEventListener('click', () => openOverlay(mainAvatar?.src || viewerImg.src));
    closeBtn?.addEventListener('click', closeOverlay);
    overlay?.addEventListener('click', (e) => {
        if (e.target === overlay || e.target.classList.contains('viewer-content-wrapper')) closeOverlay();
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && overlay.style.display === 'flex') closeOverlay();
    });
    changeBtn?.addEventListener('click', () => uploadInput?.click());

    uploadInput?.addEventListener('change', () => {
        if (!uploadInput.files || !uploadInput.files[0]) return;
        const formData = new FormData();
        formData.append('avatarFile', uploadInput.files[0]);

        fetch('/Profile/UploadAvatar', { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const newUrl = data.url + '?t=' + Date.now();
                    viewerImg.src = newUrl;
                    avatarImgs.forEach(img => img.src = newUrl);
                    closeOverlay();
                    Swal.fire('Thành công', 'Ảnh đại diện đã được cập nhật!', 'success');
                } else {
                    Swal.fire('Lỗi', data.message || 'Không thể cập nhật ảnh.', 'error');
                }
            })
            .catch(() => Swal.fire('Lỗi', 'Không thể tải lên ảnh.', 'error'));
    });
});
</script>
