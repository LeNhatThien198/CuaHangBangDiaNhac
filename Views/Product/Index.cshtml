@model StoreProductListVM
@{
    ViewData["Title"] = "Danh sách sản phẩm";

    // Dynamic Sort Label Key-Value Map
    var sortLabels = new Dictionary<string, string>
    {
        { "newest", "Mới nhất" },
        { "date_asc", "Cũ nhất" },
        { "price_asc", "Giá Tăng dần" },
        { "price_desc", "Giá Giảm dần" },
        { "name_asc", "Tên (A-Z)" },
        { "name_desc", "Tên (Z-A)" },
        { "condition_new", "Hàng Mới" },
        { "condition_used", "Hàng Cũ" },
        { "preorder", "Pre-order" }
    };
    var currentSortLabel = sortLabels.ContainsKey(Model.SortOrder ?? "newest") ? sortLabels[Model.SortOrder ?? "newest"] : "Mới nhất";

    // Build Breadcrumb Data
    string? activeCategory = null;
    if (Model.CategoryId.HasValue)
    {
        activeCategory = Model.Categories.FirstOrDefault(c => c.Id == Model.CategoryId)?.Name;
    }

    string? activeGenre = null;
    if (Model.GenreId.HasValue)
    {
        activeGenre = Model.Genres.FirstOrDefault(g => g.Id == Model.GenreId)?.Name;
    }

    string? activeArtist = null;
    if (Model.ArtistId.HasValue)
    {
        activeArtist = Model.Artists.FirstOrDefault(a => a.Id == Model.ArtistId)?.Name;
    }

    string? activeBrand = null;
    if (Model.BrandId.HasValue)
    {
        activeBrand = Model.Brands.FirstOrDefault(b => b.Id == Model.BrandId)?.Name;
    }
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}

<div class="container product-page-container">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a asp-controller="Home" asp-action="Index" class="text-decoration-none">
                    <i class="bi bi-house-door-fill me-1"></i>Trang chủ
                </a>
            </li>
            
            @if (activeCategory == null && activeGenre == null && activeArtist == null && activeBrand == null)
            {
                <li class="breadcrumb-item active" aria-current="page">Sản phẩm</li>
            }
            else
            {
                <li class="breadcrumb-item">
                    <a asp-controller="Product" asp-action="Index" class="text-decoration-none">Sản phẩm</a>
                </li>

                @if (activeCategory != null)
                {
                    if (activeGenre != null || activeArtist != null || activeBrand != null)
                    {
                        <li class="breadcrumb-item">
                            <a href="@Url.Action("Index", new { categoryId = Model.CategoryId })" class="text-decoration-none">@activeCategory</a>
                        </li>
                    }
                    else
                    {
                        <li class="breadcrumb-item active" aria-current="page">@activeCategory</li>
                    }
                }

                @if (activeGenre != null)
                {
                    if (activeArtist != null || activeBrand != null)
                    {
                         <li class="breadcrumb-item">
                            <a href="@Url.Action("Index", new { categoryId = Model.CategoryId, genreId = Model.GenreId })" class="text-decoration-none">@activeGenre</a>
                        </li>
                    }
                    else
                    {
                        <li class="breadcrumb-item active" aria-current="page">@activeGenre</li>
                    }
                }

                @if (activeArtist != null)
                {
                     if (activeBrand != null)
                    {
                         <li class="breadcrumb-item">
                            <a href="@Url.Action("Index", new { categoryId = Model.CategoryId, genreId = Model.GenreId, artistId = Model.ArtistId })" class="text-decoration-none">@activeArtist</a>
                        </li>
                    }
                    else
                    {
                        <li class="breadcrumb-item active" aria-current="page">@activeArtist</li>
                    }
                }

                @if (activeBrand != null)
                {
                    <li class="breadcrumb-item active" aria-current="page">@activeBrand</li>
                }
            }
        </ol>
    </nav>
    <div class="row">
        <!-- SIDEBAR FILTER (STICKY) -->
        <aside class="col-lg-3 mb-4">
            <div class="filter-sidebar shadow-sm" style="position: sticky; top: 90px; z-index: 900;">
                <div class="filter-scroll-content" style="max-height: calc(100vh - 130px); overflow-y: auto; padding-right: 5px;">
                <!-- 1. SEARCH -->
                <div class="filter-group">
                    <h5 class="filter-title">Tìm kiếm</h5>
                    <form action="@Url.Action("Index")" method="get" class="mb-3">
                        <div class="input-group">
                            <input type="text" name="search" class="form-control" placeholder="Tên sản phẩm..." value="@Model.Search">
                            <button class="btn btn-dark" type="submit"><i class="bi bi-search"></i></button>
                        </div>
                         <!-- Hidden Fields to keep other states -->
                        @if (Model.CategoryId.HasValue) { <input type="hidden" name="categoryId" value="@Model.CategoryId" /> }
                        @if (Model.GenreId.HasValue) { <input type="hidden" name="genreId" value="@Model.GenreId" /> }
                        @if (Model.StyleId.HasValue) { <input type="hidden" name="styleId" value="@Model.StyleId" /> }
                        @if (Model.BrandId.HasValue) { <input type="hidden" name="brandId" value="@Model.BrandId" /> }
                        @if (Model.ArtistId.HasValue) { <input type="hidden" name="artistId" value="@Model.ArtistId" /> }
                        @if (Model.IsUsed.HasValue) { <input type="hidden" name="isUsed" value="@Model.IsUsed.Value.ToString()" /> }
                        @if (!string.IsNullOrEmpty(Model.Condition)) { <input type="hidden" name="condition" value="@Model.Condition" /> }
                    </form>
                </div>

                <!-- 2. FORMAT (New) -->
                <div class="filter-group">
                    <h5 class="filter-title">Định dạng</h5>
                    <ul class="filter-list">
                        <li>
                            <a href="@Url.Action("Index", new { search = Model.Search, sortOrder = Model.SortOrder })" 
                               class="filter-link @(Model.CategoryId == null ? "active" : "")">
                                Tất cả
                            </a>
                        </li>
                        @foreach (var category in Model.Categories)
                        {
                            <li class="filter-item">
                                <a href="@Url.Action("Index", new { categoryId = category.Id, search = Model.Search, sortOrder = Model.SortOrder })" 
                                   class="filter-link @(Model.CategoryId == category.Id ? "active" : "")">
                                    @category.Name
                                </a>
                            </li>
                        }
                    </ul>
                </div>

                <!-- 3. GENRE -->
                <div class="filter-group">
                    <h5 class="filter-title">Thể loại</h5>
                    <ul class="filter-list">
                        <li>
                            <a href="@Url.Action("Index", new { search = Model.Search, sortOrder = Model.SortOrder, categoryId = Model.CategoryId })" 
                               class="filter-link @(Model.GenreId == null && Model.StyleId == null ? "active" : "")">
                                Tất cả
                            </a>
                        </li>
                        @foreach (var genre in Model.Genres)
                        {
                            <li class="filter-item">
                                <a href="@Url.Action("Index", new { genreId = genre.Id, search = Model.Search, sortOrder = Model.SortOrder, categoryId = Model.CategoryId })" 
                                   class="filter-link @(Model.GenreId == genre.Id ? "active" : "")">
                                    @genre.Name
                                </a>
                                @if (genre.Styles.Any())
                                {
                                    <ul class="sub-filter-list" style="@(Model.GenreId == genre.Id ? "display:block" : "display:none")">
                                        @foreach (var style in genre.Styles)
                                        {
                                            <li>
                                                <a href="@Url.Action("Index", new { styleId = style.Id, genreId = genre.Id, search = Model.Search, sortOrder = Model.SortOrder, categoryId = Model.CategoryId })" 
                                                   class="filter-link @(Model.StyleId == style.Id ? "active" : "")">
                                                    - @style.Name
                                                </a>
                                            </li>
                                        }
                                    </ul>
                                }
                            </li>
                        }
                    </ul>
                </div>

                <!-- 4. ARTIST -->
                <div class="filter-group">
                    <h5 class="filter-title">Nghệ sĩ</h5>
                    <div class="scrollable-filter-list">
                         <ul class="filter-list">
                            <li>
                                <a href="@Url.Action("Index", new { search = Model.Search, sortOrder = Model.SortOrder, genreId = Model.GenreId, categoryId = Model.CategoryId })"
                                   class="filter-link @(Model.ArtistId == null ? "active" : "")">Tất cả</a>
                            </li>
                            @foreach (var artist in Model.Artists)
                            {
                                <li>
                                    <a href="@Url.Action("Index", new { artistId = artist.Id, search = Model.Search, sortOrder = Model.SortOrder, genreId = Model.GenreId, categoryId = Model.CategoryId })"
                                       class="filter-link @(Model.ArtistId == artist.Id ? "active" : "")">@artist.Name</a>
                                </li>
                            }
                        </ul>
                    </div>
                </div>

                <!-- 5. BRAND -->
                <div class="filter-group">
                    <h5 class="filter-title">Hãng phát hành</h5>
                    <div class="scrollable-filter-list">
                        <ul class="filter-list">
                            <li>
                                 <a href="@Url.Action("Index", new { search = Model.Search, sortOrder = Model.SortOrder, genreId = Model.GenreId, categoryId = Model.CategoryId })"
                                   class="filter-link @(Model.BrandId == null ? "active" : "")">Tất cả</a>
                            </li>
                            @foreach (var brand in Model.Brands)
                            {
                                 <li>
                                    <a href="@Url.Action("Index", new { brandId = brand.Id, search = Model.Search, sortOrder = Model.SortOrder, genreId = Model.GenreId, categoryId = Model.CategoryId })"
                                       class="filter-link @(Model.BrandId == brand.Id ? "active" : "")">@brand.Name</a>
                                </li>
                            }
                        </ul>
                    </div>
                </div>

                <!-- 6. CONDITION (Tình trạng) -->
                <div class="filter-group">
                    <h5 class="filter-title">Tình trạng</h5>
                    <ul class="filter-list">
                        <li>
                            <a href="@Url.Action("Index", new { search = Model.Search, sortOrder = Model.SortOrder, genreId = Model.GenreId, artistId = Model.ArtistId, brandId = Model.BrandId, categoryId = Model.CategoryId })"
                               class="filter-link @(Model.IsUsed == null ? "active" : "")">Tất cả</a>
                        </li>
                        <li>
                            <a href="@Url.Action("Index", new { isUsed = false, search = Model.Search, sortOrder = Model.SortOrder, genreId = Model.GenreId, artistId = Model.ArtistId, brandId = Model.BrandId, categoryId = Model.CategoryId })"
                               class="filter-link @(Model.IsUsed == false ? "active" : "")">Mới</a>
                        </li>
                        <li>
                            <a href="@Url.Action("Index", new { isUsed = true, search = Model.Search, sortOrder = Model.SortOrder, genreId = Model.GenreId, artistId = Model.ArtistId, brandId = Model.BrandId, categoryId = Model.CategoryId })"
                               class="filter-link @(Model.IsUsed == true ? "active" : "")">Cũ</a>
                            
                            <!-- Sub-filter for Conditions (Only visible if 'Cũ' is active) -->
                            @if (Model.IsUsed == true && Model.AvailableConditions.Any())
                            {
                                <ul class="sub-filter-list" style="display:block">
                                    <li>
                                         <a href="@Url.Action("Index", new { isUsed = true, condition = (string?)null, search = Model.Search, sortOrder = Model.SortOrder, genreId = Model.GenreId, artistId = Model.ArtistId, brandId = Model.BrandId, categoryId = Model.CategoryId })"
                                           class="filter-link @(string.IsNullOrEmpty(Model.Condition) ? "active" : "")">
                                            - Tất cả
                                        </a>
                                    </li>
                                    @foreach (var cond in Model.AvailableConditions)
                                    {
                                        <li>
                                            <a href="@Url.Action("Index", new { isUsed = true, condition = cond, search = Model.Search, sortOrder = Model.SortOrder, genreId = Model.GenreId, artistId = Model.ArtistId, brandId = Model.BrandId, categoryId = Model.CategoryId })"
                                               class="filter-link @(Model.Condition == cond ? "active" : "")">
                                                - @cond
                                            </a>
                                        </li>
                                    }
                                </ul>
                            }
                        </li>
                    </ul>
                    </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="col-lg-9">
            
            <!-- TOOLBAR -->
            <div class="card shadow-sm filter-toolbar mb-4">
                <div class="card-body p-3 d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-2">
                        <i class="bi bi-music-note-list fs-5 text-primary"></i>
                        <span class="fw-bold text-muted">@Model.TotalItems kết quả</span>
                    </div>

                    <div class="d-flex gap-3 align-items-center">
                        <!-- Dynamic Sort Dropdown -->
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle d-flex align-items-center gap-2 fw-bold" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-filter"></i> @currentSortLabel
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                                <li><h6 class="dropdown-header text-uppercase small fw-bold">Thời gian</h6></li>
                                <li><a class="dropdown-item @(Model.SortOrder == "newest" || Model.SortOrder == null ? "active" : "")" href="@Url.Action("Index", new { sortOrder = "newest", search = Model.Search, genreId = Model.GenreId, artistId = Model.ArtistId, brandId = Model.BrandId, categoryId = Model.CategoryId })"><i class="bi bi-sort-down me-2"></i>Mới nhất</a></li>
                                <li><a class="dropdown-item @(Model.SortOrder == "date_asc" ? "active" : "")" href="@Url.Action("Index", new { sortOrder = "date_asc", search = Model.Search, genreId = Model.GenreId, artistId = Model.ArtistId, brandId = Model.BrandId, categoryId = Model.CategoryId })"><i class="bi bi-sort-up me-2"></i>Cũ nhất</a></li>
                                
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header text-uppercase small fw-bold">Theo Giá</h6></li>
                                <li><a class="dropdown-item @(Model.SortOrder == "price_asc" ? "active" : "")" href="@Url.Action("Index", new { sortOrder = "price_asc", search = Model.Search, genreId = Model.GenreId, artistId = Model.ArtistId, brandId = Model.BrandId, categoryId = Model.CategoryId })"><i class="bi bi-sort-numeric-down me-2"></i>Giá Tăng dần</a></li>
                                <li><a class="dropdown-item @(Model.SortOrder == "price_desc" ? "active" : "")" href="@Url.Action("Index", new { sortOrder = "price_desc", search = Model.Search, genreId = Model.GenreId, artistId = Model.ArtistId, brandId = Model.BrandId, categoryId = Model.CategoryId })"><i class="bi bi-sort-numeric-down-alt me-2"></i>Giá Giảm dần</a></li>

                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header text-uppercase small fw-bold">Theo Tên</h6></li>
                                <li><a class="dropdown-item @(Model.SortOrder == "name_asc" ? "active" : "")" href="@Url.Action("Index", new { sortOrder = "name_asc", search = Model.Search, genreId = Model.GenreId, artistId = Model.ArtistId, brandId = Model.BrandId, categoryId = Model.CategoryId })"><i class="bi bi-sort-alpha-down me-2"></i>Tên (A-Z)</a></li>
                                <li><a class="dropdown-item @(Model.SortOrder == "name_desc" ? "active" : "")" href="@Url.Action("Index", new { sortOrder = "name_desc", search = Model.Search, genreId = Model.GenreId, artistId = Model.ArtistId, brandId = Model.BrandId, categoryId = Model.CategoryId })"><i class="bi bi-sort-alpha-down-alt me-2"></i>Tên (Z-A)</a></li>
                                
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header text-uppercase small fw-bold">Trạng thái</h6></li>
                                <li><a class="dropdown-item @(Model.SortOrder == "condition_new" ? "active" : "")" href="@Url.Action("Index", new { sortOrder = "condition_new", search = Model.Search, genreId = Model.GenreId, artistId = Model.ArtistId, brandId = Model.BrandId, categoryId = Model.CategoryId })"><i class="bi bi-stars me-2"></i>Hàng Mới</a></li>
                                <li><a class="dropdown-item @(Model.SortOrder == "condition_used" ? "active" : "")" href="@Url.Action("Index", new { sortOrder = "condition_used", search = Model.Search, genreId = Model.GenreId, artistId = Model.ArtistId, brandId = Model.BrandId, categoryId = Model.CategoryId })"><i class="bi bi-recycle me-2"></i>Hàng Cũ</a></li>
                                <li><a class="dropdown-item @(Model.SortOrder == "preorder" ? "active" : "")" href="@Url.Action("Index", new { sortOrder = "preorder", search = Model.Search, genreId = Model.GenreId, artistId = Model.ArtistId, brandId = Model.BrandId, categoryId = Model.CategoryId })"><i class="bi bi-clock-history me-2"></i>Pre-order</a></li>
                            </ul>
                        </div>

                        <!-- View Mode Toggle -->
                        <div class="btn-group" role="group">
                            <button id="btnGridView" class="btn btn-outline-secondary active" title="Lưới"><i class="bi bi-grid-3x3-gap-fill"></i></button>
                            <button id="btnListView" class="btn btn-outline-secondary" title="Danh sách"><i class="bi bi-list-ul"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PRODUCT GRID -->
            <!-- Back to 4 Columns to match Home Page density -->
            <div id="productGridContainer" class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-4 product-grid-view">
                @foreach (var product in Model.Products)
                {
                    <div class="col">
                        <!-- Reusing Home Page Card styles exactly -->
                        <div class="product-card h-100 d-flex flex-column"> 
                            <a href="@Url.Action("Details", "Product", new { id = product.Id })" class="text-decoration-none d-contents-wrapper flex-grow-1">
                                <div class="card-img-wrapper">
                                    <img src="@(product.Images?.FirstOrDefault(i => i.IsPrimary)?.Url ?? "/images/no-image.png")" class="card-img-top" alt="@product.Name">
                                </div>
                                
                                <div class="card-body d-flex flex-column p-3">
                                    <!-- BADGES (Moved to Body) -->
                                    <div class="badges-container-body mb-2 d-flex flex-wrap gap-1">
                                        @if (product.PromotionPrice.HasValue) { <span class="badge bg-danger">Giảm giá</span> }
                                        @if (product.IsPreOrder) { <span class="badge bg-warning text-dark border">Pre-order</span> }
                                        @if (product.IsUsed) 
                                        { 
                                            <span class="badge bg-dark">Cũ</span> 
                                        } 
                                        else if ((DateTime.UtcNow - product.CreatedAt).TotalDays < 30) 
                                        { 
                                            <span class="badge bg-success">Mới</span> 
                                        }
                                    </div>

                                    <div class="card-info-main flex-grow-1">
                                    <h5 class="card-title fw-bold text-dark mb-1" title="@product.Name">@product.Name</h5>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <p class="card-artist text-muted small mb-0">@(product.Artist?.Name)</p>
                                        <span class="badge bg-light text-dark border">@(product.Category?.Name)</span>
                                    </div>
                                </div>
                                    <!-- Price moved to footer group -->
                                </div>
                            </a>

                            <!-- Footer Group: Price + Actions -->
                            <div class="card-footer-group">
                                <div class="card-price p-2 pb-0 d-flex flex-column align-items-start">
                                     @if (product.PromotionPrice.HasValue)
                                    {
                                        <div class="fw-bold text-danger fs-5 text-nowrap">@product.PromotionPrice.Value.ToVnd()</div>
                                        <div class="small text-muted text-decoration-line-through text-nowrap">@product.Price.ToVnd()</div>
                                    } else {
                                         <div class="fw-bold text-primary fs-5 text-nowrap">@product.Price.ToVnd()</div>
                                    }
                                </div>

                                <div class="card-actions d-flex gap-2 p-2 border-top-0 pt-2">
                                    @if (product.IsPreOrder)
                                    {
                                         <button class="btn btn-preorder btn-sm flex-grow-1 w-100 btn-buy-now" data-id="@product.Id">
                                            <i class="bi bi-clock-history me-1"></i>Đặt trước
                                        </button>
                                    }
                                    else if (product.Quantity > 0)
                                    {
                                        <button class="btn btn-outline-primary btn-sm flex-grow-1 btn-add-to-cart" data-id="@product.Id" title="Thêm vào giỏ">
                                            <i class="bi bi-cart-plus"></i>
                                        </button>
                                        <button class="btn btn-dark btn-sm flex-grow-1 btn-buy-now" data-id="@product.Id">
                                            Mua ngay
                                        </button>
                                    }
                                    else
                                    {
                                        <button class="btn btn-danger btn-sm flex-grow-1 fw-bold" disabled>HẾT HÀNG</button>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- PAGINATION -->
            @{
                var totalPages = Model.Pagination?.TotalPages ?? 0;
                var currentPage = Model.Pagination?.PageNumber ?? 1;
            }

            @if (totalPages > 1)
            {
                <nav class="mt-4" aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                            <a class="page-link" href="@Url.Action("Index", new { page = currentPage - 1, sortOrder = Model.SortOrder, search = Model.Search, genreId = Model.GenreId, artistId = Model.ArtistId, brandId = Model.BrandId, styleId = Model.StyleId, isUsed = Model.IsUsed, condition = Model.Condition, categoryId = Model.CategoryId })">Trước</a>
                        </li>
                        @for (int i = 1; i <= totalPages; i++)
                        {
                            <li class="page-item @(currentPage == i ? "active" : "")">
                                <a class="page-link" href="@Url.Action("Index", new { page = i, sortOrder = Model.SortOrder, search = Model.Search, genreId = Model.GenreId, artistId = Model.ArtistId, brandId = Model.BrandId, styleId = Model.StyleId, isUsed = Model.IsUsed, condition = Model.Condition, categoryId = Model.CategoryId })">@i</a>
                            </li>
                        }
                        <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                            <a class="page-link" href="@Url.Action("Index", new { page = currentPage + 1, sortOrder = Model.SortOrder, search = Model.Search, genreId = Model.GenreId, artistId = Model.ArtistId, brandId = Model.BrandId, styleId = Model.StyleId, isUsed = Model.IsUsed, condition = Model.Condition, categoryId = Model.CategoryId })">Sau</a>
                        </li>
                    </ul>
                </nav>
            }
        </main>
    </div>
</div>
