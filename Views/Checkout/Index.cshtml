@model CuaHangBangDiaNhac.ViewModels.CheckoutViewModel
@{
    ViewData["Title"] = "Thanh toán";
}

<div class="container py-5">
    <form asp-action="PlaceOrder" method="post" id="checkoutForm">
        @foreach (var id in Model.SelectedIds)
        {
            <input type="hidden" name="SelectedIds" value="@id" />
        }

        <div class="row g-5">
            <!-- LEFT COLUMN: Input Info -->
            <div class="col-lg-8">
                <h4 class="fw-extra-bold mb-4">Thông tin thanh toán</h4>

                <!-- 1. Address Section -->
                <div class="checkout-section-card">
                    <div class="checkout-section-header">
                        <div class="checkout-icon-circle"><i class="bi bi-geo-alt-fill"></i></div>
                        <div>
                            <h5 class="fw-bold mb-0">Địa chỉ nhận hàng</h5>
                            <small class="text-muted">Chọn địa chỉ giao hàng của bạn</small>
                        </div>
                        <a asp-controller="Profile" asp-action="Address" class="ms-auto btn btn-outline-dark btn-sm rounded-pill fw-bold">Quản lý</a>
                    </div>

                    @if (Model.Addresses != null && Model.Addresses.Any())
                    {
                        <div class="row g-3">
                            @foreach (var address in Model.Addresses)
                            {
                                <div class="col-12">
                                    <label class="custom-radio-card h-100">
                                        <input type="radio" asp-for="SelectedAddressId" value="@address.Id" checked="@(address.Id == Model.SelectedAddressId)" />
                                        <span class="radio-indicator"></span>
                                        <div class="pe-4">
                                            <div class="d-flex align-items-center mb-1">
                                                <span class="fw-bold me-2">@address.ReceiverName</span>
                                                <span class="text-muted small">| @address.PhoneNumber</span>
                                                @if (address.IsDefault)
                                                {
                                                    <span class="badge bg-light text-dark border ms-2">Mặc định</span>
                                                }
                                            </div>
                                            <p class="mb-0 text-muted small">
                                                 @{
                                                     var checkParts = new List<string>();
                                                     if (!string.IsNullOrWhiteSpace(address.Province)) checkParts.Add(address.Province);
                                                     if (!string.IsNullOrWhiteSpace(address.Line2)) checkParts.Add(address.Line2);
                                                     if (!string.IsNullOrWhiteSpace(address.Line1)) checkParts.Add(address.Line1);
                                                 }
                                                 @string.Join(", ", checkParts)
                                            </p>
                                        </div>
                                    </label>
                                </div>
                            }
                        </div>
                        <div class="mt-3">
                             <a asp-controller="Profile" asp-action="Address" asp-route-returnUrl="/Checkout" class="btn btn-link text-decoration-none fw-bold p-0"><i class="bi bi-plus-lg me-1"></i>Thêm địa chỉ mới</a>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4 bg-light rounded">
                            <p class="text-muted mb-3">Bạn chưa có địa chỉ nào.</p>
                            <a asp-controller="Profile" asp-action="Address" asp-route-returnUrl="/Checkout" class="btn btn-dark rounded-pill px-4">Thêm địa chỉ ngay</a>
                        </div>
                    }
                </div>

                <!-- 2. Payment Method -->
                <div class="checkout-section-card">
                     <div class="checkout-section-header">
                        <div class="checkout-icon-circle"><i class="bi bi-credit-card-2-front-fill"></i></div>
                        <div>
                            <h5 class="fw-bold mb-0">Phương thức thanh toán</h5>
                            <small class="text-muted">An toàn và bảo mật</small>
                        </div>
                    </div>

                    @if (Model.HasPreOrder)
                    {
                        <div class="alert alert-warning border-0 d-flex align-items-center mb-4">
                            <i class="bi bi-info-circle-fill fs-4 me-3"></i>
                            <div>
                                <strong>Đơn hàng Pre-order:</strong> Bạn cần thanh toán chuyển khoản (toàn bộ hoặc cọc) cho đơn hàng này. COD không khả dụng.
                            </div>
                        </div>
                    }

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="custom-radio-card h-100 @(Model.HasPreOrder ? "opacity-50" : "")">
                                <input type="radio" asp-for="PaymentMethod" value="COD" disabled="@(Model.HasPreOrder ? "disabled" : null)">
                                <span class="radio-indicator"></span>
                                <div class="text-center py-3">
                                    <i class="bi bi-cash-stack fs-2 mb-2 d-block text-muted"></i>
                                    <span class="fw-bold d-block">COD</span>
                                    <span class="small text-muted">Thanh toán khi nhận hàng</span>
                                </div>
                            </label>
                        </div>
                        <div class="col-md-6">
                             <label class="custom-radio-card h-100">
                                <input type="radio" asp-for="PaymentMethod" value="Transfer" id="paymentTransfer">
                                <span class="radio-indicator"></span>
                                 <div class="text-center py-3">
                                    <i class="bi bi-bank fs-2 mb-2 d-block text-muted"></i>
                                    <span class="fw-bold d-block">Chuyển khoản</span>
                                    <span class="small text-muted">Qua mã QR ngân hàng</span>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 3. Shipment Details -->
                <div class="checkout-section-card">
                     <div class="checkout-section-header">
                        <div class="checkout-icon-circle"><i class="bi bi-box-seam-fill"></i></div>
                        <div>
                            <h5 class="fw-bold mb-0">Chi tiết kiện hàng</h5>
                            <small class="text-muted">@Model.Shipments.Count lần giao</small>
                        </div>
                    </div>

                    @foreach (var shipment in Model.Shipments)
                    {
                        <div class="mb-4 last:mb-0">
                            <div class="d-flex justify-content-between align-items-center bg-light p-3 rounded-top">
                                <span class="fw-bold">@shipment.Title</span>
                                <span class="badge bg-white text-dark border">Ship: @shipment.ShippingFee.ToString("N0") đ</span>
                            </div>
                            <div class="border border-top-0 rounded-bottom p-3">
                                @foreach (var item in shipment.Items)
                                {
                                    <div class="checkout-product-item">
                                        <img src="@item.ProductImage" class="checkout-product-thumb" alt="@item.ProductName">
                                        <div class="flex-grow-1">
                                            <h6 class="fw-bold text-dark mb-1">@item.ProductName</h6>
                                            <div class="text-muted small">@item.ArtistName</div>
                                        </div>
                                        <div class="text-end ps-3">
                                            <div class="fw-bold">@(( (item.PromotionPrice ?? item.Price) * item.Quantity ).ToString("N0")) đ</div>
                                            <div class="text-muted small">x @item.Quantity</div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- RIGHT COLUMN: Summary -->
            <div class="col-lg-4">
                <div class="order-summary-card">
                    <h5 class="fw-extra-bold mb-4">Tổng quan đơn hàng</h5>
                    
                    <div class="d-flex justify-content-between mb-3">
                        <span class="text-muted">Tiền hàng</span>
                        <span class="fw-bold">@Model.TotalMerchandiseAmount.ToString("N0") đ</span>
                    </div>

                    <div class="d-flex justify-content-between mb-3 border-bottom pb-3">
                        <span class="text-muted">Phí vận chuyển</span>
                        <span class="fw-bold">@Model.TotalShippingFee.ToString("N0") đ</span>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <span class="h5 fw-bold mb-0">Tổng thanh toán</span>
                        <span class="h3 fw-extra-bold text-danger mb-0">@Model.GrandTotal.ToString("N0") đ</span>
                    </div>

                    <button type="submit" class="btn btn-dark w-100 py-3 rounded-pill fw-bold shadow hover-shadow transition-all text-uppercase">
                        Đặt hàng ngay
                    </button>

                    <div class="mt-4 pt-3 border-top text-center">
                        <div class="d-flex justify-content-center gap-3 text-muted fs-4">
                            <i class="bi bi-shield-check" title="Bảo mật"></i>
                            <i class="bi bi-credit-card" title="Thẻ tín dụng"></i>
                            <i class="bi bi-qr-code" title="QR Code"></i>
                        </div>
                        <p class="small text-muted mt-2 mb-0">Cam kết bảo mật thông tin thanh toán.</p>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <style>
        .hover-shadow:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.15) !important; }
        .transition-all { transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
    </style>
    <script>
        $(document).ready(function() {
            function updateRadioStyles() {
                $('.custom-radio-card').removeClass('active');
                $('input[type="radio"]:checked').closest('.custom-radio-card').addClass('active');
            }
            updateRadioStyles();
            $('input[type="radio"]').change(updateRadioStyles);
        });
    </script>
}
